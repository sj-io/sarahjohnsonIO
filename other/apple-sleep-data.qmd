---
title: "Analyze Apple Health sleep data with R"
freeze: auto
toc: true
toc-location: left
layout: full
date: "2023-12-14"
date-modified: "2023-12-18"
image: "preview-image.png"
author: 
  - name: Sarah Johnson
    url: https://sarahjohnson.io
citation: true
---

I've always struggled with falling asleep early, so I purchased an Apple Watch to monitor my sleep. This post details how to access your Apple Health data and analyze it.

# Export your Health data {#get-data}

Unfortunately I could not find a direct way to access the health data, but you can export it from the Apple Health app by clicking on your profile.

::: {layout-ncol=2}
![Click your profile picture.](apple-health-get-sleep-data-1.PNG)

![Scroll to the bottom and export data.](apple-health-get-sleep-data-2.PNG)
:::

Note that this exports all of your health data, so it will likely be a large file.

The export is a zipped folder, which I airdropped to my Mac and unzipped. The file that contains all your data is `export.xml`.

# Convert XML to a table

We can use the `xml2` package to access this data in R. First, load your libraries.

```{r, message=FALSE, warning=FALSE}
# install.packages(c("tidyverse", "arrow"))
library(tidyverse)
library(xml2)
library(arrow) # optional
```

```{r, echo=FALSE, message=FALSE}
path <- Sys.getenv("MAIN_DATA_DIR")
```

`xml2` is included in the `tidyverse` and does not need to be installed separately. I use the `arrow` package to save the cleaned data as parquet files because they take up less space than csv files and load faster.

### Read the XML file

First, read the xml file using the `xml2::read_xml()` function.

```{r echo=FALSE, eval=FALSE}
# read your health data file
xml <- read_xml(paste0(path, "apple_health_export/export.xml"))
```

```{r eval=FALSE}
xml <- read_xml("/Users/JaneDoe/Data/apple_health_export/export.xml")
```

This file is large and takes up a lot of memory, so let's narrow down to the information we need and export the data to something easier to work with.

### Access health records

There's some valuable information at the top of the xml document on what tables are included in the file and related metadata. This post will focus on the **Record** table, but other data available includes Activity Summary, Workout, Clinical Record, and more.

Below are the attributes for the Records data, which we will turn into columns.

![](apple-health-records-attributes.png)

Use `xml_find_all("//Record")` to narrow the xml document to just your health records.

```{r eval=FALSE}
xml_records <- xml |> xml_find_all("//Record")
col_names <- c("type", "sourceName", "sourceVersion", "creationDate", "startDate", "endDate", "value", "unit")
```

Create a `col_names` vector to list which information you want to pull from each element.

### XML attribute data to table

Converting data from an XML document to a table is a learning experience. I attempted to use [Taras Kaduk's](https://taraskaduk.com/posts/2019-03-23-apple-health/) method of using `XML::xmlAttrsToDataFrame()` function, only to find the function no longer exists. When I tried using `XML::xmlToDataFrame()`, the process took so long I was worried R would hang.

Instead, I created an `xml_to_tibble()` function to gather this data.^[This function was inspired by previous XML data wrangling functions I'd created for my Mario Kart speedrunning R package, [`mk8dx`](https://github.com/sj-io/mk8dx), specifically the [`mk_lss()`](https://github.com/sj-io/mk8dx/blob/main/R/mk_lss.R) function.]

```{r eval=FALSE}
attr_to_col <- function(xml, attr_cols) {
  as_tibble_col(xml_attr(xml, attr_cols), column_name = attr_cols)
}

xml_to_tibble <- function(xml_data, attr_cols) {
  map(attr_cols, ~ {attr_to_col(xml_data, .x)}) |> list_cbind()
}
```

First, the `attr_to_col()` function pulls attribute data from each xml element. This data is placed in a column; the length of the column will be the same as the number of records in the xml data. Attributes missing from an element will have a value of NA.

The `xml_to_tibble()` function runs the above function for each attribute defined in `col_names`. Then, all the columns are binded together into one table.

```{r eval=FALSE}
records <- xml_to_tibble(xml_records, col_names) |> 
  mutate(
    across(ends_with("Date"), ~ as_datetime(.x) |> with_tz("US/Central")),
    type = str_remove_all(type, "HK(Category|Quantity)TypeIdentifier"),
    value = str_remove_all(value, "HKCategoryValue(SleepAnalysis)?")
  )
```

Clean up your records table by converting date columns and making some values more legible.

Note this changes all date columns to US/Central timezone; excluding the timezone adjustment keeps all data in UTC time. I might adjust my code in the future to use the local timezone of wherever the data was collected.

### Narrow for sleep data

The records table contains a lot of information. You can use `unique(records$type)` to see all available data^[[Taras Kaduk's](https://taraskaduk.com/posts/2019-03-23-apple-health/) blog post also shows other data available for analysis.], but this post will focus on sleep data.

```{r eval=FALSE}
sleep_data <- records |> 
  filter(type == "SleepAnalysis") |> 
  select(-c(type, unit))
```

Now that we have the XML data in tables, let's save it in a different format so it's easier to manage.

### Save data

Save the data with `write_parquet()` or `write_csv()`.

```{r eval=FALSE}
# save data as parquet (requires arrow package)
write_parquet(records, paste0(path, "health/records.parquet"))
write_parquet(sleep_data, paste0(path, "health/sleep.parquet"))

# alt: save as a csv file (larger file size)
write_csv(sleep_data, paste0(path, "health/sleep.csv"))
write_csv(records, paste0(path, "health/health.csv"))
```

Congratulations! You now have all your health records saved in an easy format.

# Analyze your sleep data

To access the data again, just use `read_parquet()`.

```{r}
sleep_data <- read_parquet(paste0(path, "health/sleep.parquet"))
  # filter(str_detect(sourceName, "Watch"))

glimpse(sleep_data)
```

The **value** column shows what type of sleep activity was recorded. The **startDate** and **endDate** details when the activity took place. The **creationDate** is linked to a group of sleep activity, like one night's worth of sleep. 

This post will focus on rows where I'm asleep, so let's filter for that. All of these rows will start with "Asleep" in the **value** column.

```{r}
asleep <- sleep_data |> 
  filter(str_detect(value, "Asleep")) |> 
  mutate(value = str_remove(value, "Asleep"),
         creationDate = date(creationDate)) |> 
  select(-starts_with("source"))
```

I also changed the **creationDate** to remove the time for easier future use.

Click below to see theme options for my plots.

```{r, message=FALSE}
#| code-fold: true
library(ggrounded)

library(showtext)
font_add(family = "SF Pro", regular = "SF-Pro.ttf", bold = "SF-Pro.ttf")
font_add(family = "SF Pro Rounded", regular = "SF-Pro-Rounded-Regular.otf", bold = "SF-Pro-Rounded-Bold.otf")
showtext_auto()

sleep_colors <- c(
  "REM" = "#80CFF9",
  "Core" = "#3A81F6",
  "Deep" = "#35339C",
  "Unspecified" = "#87E3E0"
)
# colors from Apple Health app

sleep_theme <- theme(
    plot.margin = margin(1.5, 1, 1, 1.25, "cm"),
    plot.background = element_rect(fill = "#1C1B1D"),
    panel.grid = element_line(color = "#4B4A4C"),
    text = element_text(colour = "#94949B", family = "SF Pro Rounded"),
    axis.title.y = element_text(vjust = 5),
    axis.text = element_text(color = "#94949B"),
    plot.title = element_text(colour = "white", vjust = 4, size = 24, face = "bold"),
    plot.caption = element_text(face = "bold", size = 10)
  )
```

## Sleep by day of week

How much sleep do I average for each night of the week?

```{r}
sleep_by_wday <- asleep |> 
  mutate(activity_amount = endDate - startDate) |> 
  summarise(daily_sleep = sum(activity_amount), .by = creationDate) |> 
  mutate(wday = wday(creationDate, label = TRUE)) |> 
  summarise(wday_sleep = mean(daily_sleep), .by = wday) |> 
  mutate(readable = seconds_to_period(wday_sleep))
```

Get the amount of sleep for each record by subtracting the **endDate** by the **startDate**. Group by **creationDate** to sum up all sleep activity for each night.

Then, use `lubridate::wday()` function to get the day of the week. Finally, find the average amount of sleep for each weekday. The total will be given in seconds; turn this into a readable format with `seconds_to_period()`.

Turn the table into a graph with ggplot's `geom_col()`, or `ggrounded::geom_col_rounded()` for a bar graph with rounded edges.

::: {.panel-tabset}

### Graph

```{r fig.width=8, fig.height=5, fig.showtext=TRUE, echo=FALSE}
sleep_by_wday |>
  ggplot() +
  geom_col_rounded(aes(
    x = wday,
    y = wday_sleep,
    fill = as.numeric(wday_sleep)
  )) +
  scale_y_time(labels = scales::label_time(format = "%H H")) +
  scale_fill_gradient(low = "#35339C", high = "#80CFF9") +
  theme_minimal() +
  labs(title = "Average sleep by day of week",
       y = "", x = "",
       caption = "sarahjohnson.io") +
  theme(legend.position = "none") +
  sleep_theme
```

### Code

```{r eval=FALSE}
sleep_by_wday |>
  ggplot() +
  geom_col_rounded(aes(
    x = wday,
    y = wday_sleep,
    fill = as.numeric(wday_sleep)
  )) +
  scale_y_time(labels = scales::label_time(format = "%H H")) +
  scale_fill_gradient(low = "#35339C", high = "#80CFF9") +
  theme_minimal() +
  labs(title = "Average sleep by day of week",
       y = "", x = "",
       caption = "sarahjohnson.io") +
  theme(legend.position = "none") +
  sleep_theme
```

:::

Unsurprisingly, I get the most sleep on Saturdays where I average 8.5 hours, followed by Sunday with 7.5 hours. All weekdays I average below 7 hours of sleep, with Monday averaging under 6 hours (5H 44M).

## Sleep cycle amounts

How much of each sleep cycle do I experience each night?

```{r}
cycle_by_day <- asleep |>
  mutate(cycle_amount = endDate - startDate) |>
  summarise(cycle_amount = sum(cycle_amount),
            .by = c("creationDate", "value"))
```

Again get the amount of sleep activity for each row and sum the amounts. This time we will also group by the **value** column which defines the type of sleep activity.

::: {.panel-tabset}

### Stack

```{r, fig.width=12, fig.height=5, echo=FALSE}
#| column: screen-inset-right
cycle_by_day |>
  ggplot() +
  geom_col_rounded(aes(x = creationDate, y = cycle_amount, fill = value),
                   radius = grid::unit(2, "pt")) +
  scale_fill_manual(values = sleep_colors) +
  scale_y_time(expand = c(0, 0),
               breaks = seq(3600, 50400, by = 7200),
               minor_breaks = NULL,
               labels = scales::label_time(format = "%H H")) +
  scale_x_date(expand = c(0, 5),
               breaks = "1 month",
               minor_breaks = NULL,
               date_labels = "%b") +
  theme_minimal() +
  labs(
    title = "Daily sleep cycles",
    x = "",
    y = "",
    fill = "Sleep Stage",
    caption = "sarahjohnson.io"
  ) +
  guides(fill = guide_legend(title.position = "top")) +
  theme(legend.position = "bottom",
        legend.box.margin = margin(0, 7.4, 0, 0, unit = "in")) +
  sleep_theme
```

### Fill

```{r, fig.width=12, fig.height=5, echo=FALSE}
#| column: screen-inset-right
cycle_by_day |>
  ggplot() +
  geom_col_rounded(aes(x = creationDate, y = cycle_amount, fill = value),
           position = "fill",
           radius = grid::unit(1, "pt")) +
  scale_fill_manual(values = sleep_colors) +
  scale_y_continuous(labels = scales::label_percent(),
                     minor_breaks = NULL) +
  scale_x_date(expand = c(0, 5),
               breaks = "1 month",
               minor_breaks = NULL,
               date_labels = "%b") +
  theme_minimal() +
  labs(
    title = "Daily sleep cycles",
    x = "",
    y = "",
    fill = "Sleep Stage",
    caption = "sarahjohnson.io"
  ) +
  guides(fill = guide_legend(title.position = "top")) +
  theme(legend.position = "bottom",
        legend.box.margin = margin(0, 7.4, 0, 0, unit = "in")) +
  sleep_theme
```

### Code

```{r eval=FALSE}
cycle_by_day |>
  ggplot() +
  geom_col_rounded(aes(x = creationDate, y = cycle_amount, fill = value),
                   radius = grid::unit(1, "pt")
                   # position = "fill"
                   ) +
  geom_vline(aes(xintercept = as_date("2023-5-17")), color = "pink", linewidth = .5) +
  geom_vline(aes(xintercept = as_date("2023-8-1")), color = "pink", linewidth = .5) +
  scale_fill_manual(values = sleep_colors) +
  scale_y_time(expand = c(0, 0),
               breaks = seq(3600, 43200, by = 3600),
               minor_breaks = NULL,
               labels = scales::label_time(format = "%HH")) +
  scale_x_date(expand = c(0, 5),
               breaks = "1 month",
               minor_breaks = NULL,
               date_labels = "%b") +
  theme_minimal() +
  labs(
    title = "Daily sleep cycles",
    x = "",
    y = "",
    fill = "Sleep Stage",
    caption = "sarahjohnson.io"
  ) +
  theme(legend.position = "bottom",
        legend.box.margin = margin(.25, 4.5, 0, 0, unit = "cm")) +
  sleep_theme
```


:::

## Sleep cycle activity

How do I make a sleep graph similar to the one in Apple's Health app?

<center>
![](apple-health-sleep-graph.jpg){width=40%}
</center><br>

I've always wanted to view the sleep cycle for all days at once. However, the graph needs some adjustments to plot correctly.

If you attempt to use the **startDate** or **endDate** on the y-axis, the dates will prevent the times from aligning. The result is a bunch of very short lines stacking diagonally into oblivion. Use `hms::as_hms()` to pull just the time.^[`lubridate::hms()` is used for time periods, like a race that takes 3H 42M 6S.]

```{r, message=FALSE}
cycle_activity <- asleep |>
  mutate(start_time = hms::as_hms(startDate),
         end_time = hms::as_hms(endDate)) |>
  mutate(across(ends_with("_time"), ~ ifelse(
    as.numeric(.x) <= 48000,
    .x + hms::hms(0, 0, 24),
    .x
  ) |> hms::as_hms()))
```

The next problem I ran into was that sleep starts on one night and ends on the next. If you do not adjust the hours and y-axis, you'll have a disjoined graph. Assuming a normal sleep schedule, a bit of the data will be at the bottom (for hours slept between ~10PM/22:00 to midnight) and a large amount towards the top (for midnight/00:00 to wake-up), and there will be a large gap of no data in the middle for hours you are awake.

To correct for this, pick a halfway time where any value under this period has 24 hours added. The halfway time should be a period where you were awake on all days (so if there isn't a time like that for you, stick with the regular 24-hour cycle).

There was one sliver of time between 1:00PM and 1:30PM where I was awake on all days. I decided all times before 1:20PM (48000 seconds) to add 24 hours. If I had a cycle that started at 11:55PM/23:55 and ended at 12:05AM/00:05, the end time would now read as 24:05. The graph would originally show two 5 minute chunks at the top and bottom of the graph, now will show one 10 minute bar in the middle of the graph. Thankfully ggplot's labelling automatically turns these times into values like "6AM". 

Lastly, I wanted to see my typical wake and sleep times, but with the day-to-day variances smoothed out. 

```{r, message=FALSE}
sleep_start <- cycle_activity |> 
  slice_min(start_time, by = "creationDate")

sleep_end <- cycle_activity |> 
  slice_max(end_time, by = "creationDate")
```

To get this data, just slice your earliest and latest sleep time for each day.

::: {.panel-tabset}

### Sleep Activity

```{r, fig.width=12, fig.height=5, echo=FALSE}
#| column: screen-inset-right
ggplot() +
  geom_rect(
    data = cycle_activity,
    aes(
      xmin = creationDate,
      xmax = creationDate + days(1),
      ymin = end_time,
      ymax = start_time,
      color = value,
      fill = value
    ),
    linejoin = "round"
  ) +
  scale_color_manual(values = sleep_colors,
                     aesthetics = c("colour", "fill")) +
  scale_x_date(expand = c(0, 5),
               breaks = "1 month",
               date_labels = "%b") +
  scale_y_time(expand = c(0, 0),
               breaks = seq(48000, 134400, by = 7200),
               minor_breaks = NULL,
               labels = scales::label_time(format = "%I %p")) +
  theme_minimal() +
  labs(
    x = "",
    y = "",
    title = "Daily sleep activity",
    caption = "sarahjohnson.io"
  ) +
  theme(legend.position = "none") +
  sleep_theme
```


### Smooth Sleep/Wake

```{r, fig.width=12, fig.height=5, echo=FALSE, message=FALSE}
#| column: screen-inset-right
ggplot() +
  geom_rect(
    data = cycle_activity,
    aes(
      xmin = creationDate,
      xmax = creationDate + days(1),
      ymin = start_time,
      ymax = end_time,
      color = value,
      fill = value
    ),
    linejoin = "round"
  ) +
  geom_smooth(data = sleep_start, aes(x = creationDate, y = start_time)) +
  geom_smooth(data = sleep_end, aes(x = creationDate, y = end_time)) +
  scale_color_manual(values = sleep_colors,
                     aesthetics = c("colour", "fill")) +
  scale_x_date(expand = c(0, 5),
               breaks = "1 month",
               date_labels = "%b") +
  scale_y_time(expand = c(0, 0),
               breaks = seq(48000, 134400, by = 7200),
               minor_breaks = NULL,
               labels = scales::label_time(format = "%I %p")) +
  theme_minimal() +
  labs(
    x = "",
    y = "",
    title = "Daily sleep activity",
    caption = "sarahjohnson.io"
  ) +
  theme(legend.position = "none") +
  sleep_theme
```

### Code

```{r, eval=FALSE}
ggplot() +
  geom_rect(
    data = cycle_activity,
    aes(
      xmin = creationDate,
      xmax = creationDate + days(1),
      ymin = start_time,
      ymax = end_time,
      color = value,
      fill = value
    ),
    linejoin = "round"
  ) +
  geom_smooth(data = sleep_start, aes(x = creationDate, y = start_time)) +
  geom_smooth(data = sleep_end, aes(x = creationDate, y = end_time)) +
  scale_color_manual(values = sleep_colors,
                     aesthetics = c("colour", "fill")) +
  scale_x_date(expand = c(0, 5),
               breaks = "1 month",
               date_labels = "%b") +
  scale_y_time(expand = c(0, 0),
               breaks = seq(48000, 134400, by = 7200), # 3600 = 1H
               minor_breaks = NULL,
               labels = scales::label_time(format = "%I %p")) + # %H for 24-hour time
  theme_minimal() +
  labs(
    x = "",
    y = "Time",
    title = "Daily sleep activity",
    caption = "sarahjohnson.io"
  ) +
  theme(legend.position = "none") +
  sleep_theme
```

:::

## Sleep heatmap

```{r}
sleep_heatmap <- asleep |> 
  mutate(activity_amount = endDate - startDate) |> 
  summarise(daily_sleep = sum(activity_amount), .by = creationDate) |> 
  mutate(wday = wday(creationDate, label = TRUE),
         week = week(creationDate))
```

::: {.panel-tabset}

### Heatmap

```{r, fig.width=12, fig.height=4.75, echo=FALSE}
#| column: screen-inset-right
sleep_heatmap |> 
  ggplot(aes(x = week, y = wday, fill = as.numeric(daily_sleep)/3600)) +
  geom_tile() +
  scale_x_continuous(
    breaks = c(18, 23, 27, 32, 36, 40, 44, 49),
    labels = c("May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  ) +
  scale_fill_gradient(high = "#35339C", low = "#80CFF9",
                      breaks = seq(0, 15, by = 3)
                      ) +
  coord_equal() +
  theme_minimal() +
  labs(x = "", y = "", title = "Weekly sleep heatmap", 
       fill = "Hours of sleep", caption = "sarahjohnson.io") +
  guides(fill = guide_legend(title.position = "top",
                             label.position = "bottom")) +
  theme(legend.position = "bottom",
        legend.box.margin = margin(0, 9, 0, 0, unit = "in"),
        panel.grid.major = element_blank()) +
  sleep_theme
```

### Code

```{r eval=FALSE}
sleep_heatmap |> 
  ggplot(aes(x = week, y = wday, fill = as.numeric(daily_sleep))) +
  geom_tile() +
  scale_x_continuous(
    breaks = c(18, 23, 27, 32, 36, 40, 44, 49),
    labels = c("May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec")
  ) +
  scale_fill_gradient(high = "#35339C", low = "#80CFF9",
                      breaks = seq(0, 43200, by = 7200),
                      labels = c("0", "2", "4", "6", "8", "10", "12")) +
  coord_equal() +
  theme_minimal() +
  labs(x = "", y = "", title = "Weekly sleep heatmap", 
       fill = "Hours of sleep", caption = "sarahjohnson.io") +
  guides(fill = guide_legend(title.position = "top",
                             label.position = "bottom")) +
  theme(legend.position = "bottom",
        legend.margin = margin(0, 8, 0, 0, unit = "cm"),
        panel.grid.major = element_blank()) +
  sleep_theme
```

:::

## Acknowledgments {.appendix}

Inspiration for this post from [Jon Busby's blog](https://www.jonbusby.co.uk/2021/06/analysing-apple-health-data-in-python-part-1-extraction-and-sleep-data/), who used Python to access this data.

[Taras Kaduk's blog](https://taraskaduk.com/posts/2019-03-23-apple-health/) who also used R to gather Apple Health data; also inspired heat map.

[Relevant Miscellany](https://www.relevantmisc.com/r/2020/06/01/baby-sleep-radial/)'s sleep data mapping also helped inspire this post.

[This stackoverflow question](https://stackoverflow.com/questions/68578242/plot-arrival-and-departure-times-that-cross-midnight) helped me figure out how to graph across midnight.
